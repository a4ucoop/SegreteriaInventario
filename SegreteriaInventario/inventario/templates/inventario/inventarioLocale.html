{% extends "base.html" %}
{% load staticfiles %}
{% load widget_tweaks %}
{% load i18n %}
{% load custom_filters %}

{% block stylesheets %}

<link href="{% static 'css/bootstrap/bootstrap-table/extensions/editable/bootstrap-editable.css'%}" rel="stylesheet">
<link href="{% static 'css/bootstrap/simple-sidebar/simple-sidebar.css'%}" rel="stylesheet">
<link href="{% static 'inventario/css/showLocalDBTableColumns.css'%}" rel="stylesheet">
{% endblock %}



{% block javascripts %}

<script type="text/javascript" src="{% static 'js/jquery.qrcode-0.12.0.min.js' %}"></script>
{% endblock %}


{% block toggle_sidebar %}

<li id="showRapidSearch"><a href="#" ><b>Ricerca Rapida</b></a></li>
{% if user.is_authenticated %}
<li><a><b> Benvenuto {% if user.first_name and user.last_name %} {{ user.first_name}} {{ user.last_name }} {% else %} {{user.username}} {% endif %}</b></a></li>
{% endif %}

{% endblock %}


{% block body %}
<div id="wrapper" class="toggled">

    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <li class="sidebar-brand">
                <a href="#" id="hideRapidSearch">
                    Ricerca rapida
                </a>
            </li>
            <!--  Ubicazioni  -->
              <li>
                  <a href="#" id="btn-1" data-toggle="collapse" data-target="#submenu1" aria-expanded="false">Ubicazioni</a>
                  <ul class="nav collapse" id="submenu1" role="menu" aria-labelledby="btn-1">
                  {% for l in locations %}
                      <li ><a style="line-height:10px" href="#" title="{{l}}" onClick="locationSearch('{{l}}', this)">{{l}}</a></li>
                  {%endfor%}
                  </ul>    
              </li>
            <!--  Ubicazioni Precise  -->
            <li>
                <a href="#" id="btn-2" data-toggle="collapse" data-target="#submenu2" aria-expanded="false">Ubicazioni Precise</a>
                <ul class="nav collapse" id="submenu2" role="menu" aria-labelledby="btn-2">
                {% for al in accurateLocations %}
                    <li ><a style="line-height:10px" href="#" title="{{al}}" onClick="accurateLocationSearch('{{al}}', this)">{{al}}</a></li>
                {%endfor%}
                </ul>    
            </li>
            <!--  Possessori  -->
            {% if user.is_authenticated and user.is_superuser %}
            <li>
                <a href="#" id="btn-3" data-toggle="collapse" data-target="#submenu3" aria-expanded="false">Possessori</a>
                <ul class="nav collapse" id="submenu3" role="menu" aria-labelledby="btn-3">
                {% for al in possessori %}
                    <li ><a style="line-height:10px" href="#" title="{{al.0}} {{ al.1}}" onClick="possessoriSearch('{{al.0}}','{{al.1}}', this)">{{al.0}} {{ al.1}}</a></li>
                {%endfor%}
                </ul>    
            </li>
            {% endif %}
        </ul>
    </div>
    <!-- /#sidebar-wrapper -->

    <div class="container col-xs-12" style="height:100%">
        <div id="toolbar">
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="location.href='{% url 'checkUpdate' %}'"
                      title="Aggiornamento Parziale"
                      >
                <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
              </button>
              <button type="button"
                      class="btn btn-default"
                      onClick="location.href='{% url 'updateLocalDB' %}'"
                      title="Aggiornamento Completo"
                      >
                <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="printQrCodes()"
                      title="Stampa codici QR selezionati"
                      >
                <span class="glyphicon glyphicon-qrcode" aria-hidden="true"></span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="showNewAccLocationDiv()"
                      title="Nuovo locale"
                      >
                <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>
              </button>
            </div>
            <div id="newAccLocationDiv" class="btn-group" role="group" style="display:none">
                <div class="btn-group" role="group">
                    <input type="text" class="form-control" id="newAccLocationText" placeholder="Nuovo locale...">
                </div>
                <div class="btn-group" role="group">
                  <button type="button"
                          class="btn btn-default"
                          onClick="addLocation()"
                          >
                    <!-- <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> -->
                  <b>ok</b>
                  </button>
                </div>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="$('#advancedSearchModal').modal();"
                      title="Ricerca Avanzata"
                      >
                <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="clearFilters();"
                      title="Rimuovi i filtri"
                      >
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
              </button>
            </div>
        </div>

<div class="table-responsive">
        <table id="table"
               data-locale="it-IT"
               data-toolbar="#toolbar"
               data-search="true"
               data-show-refresh="false"
               data-show-toggle="false"
               data-show-columns="true"
               data-show-export="true"
               data-detail-view="true"
               data-detail-formatter="detailFormatter"
               data-minimum-count-columns="2"
               data-show-pagination-switch="false"
               data-pagination="true"
               data-id-field="id_bene"
               data-page-size="25"  
               data-page-list="[1, 10, 25, 50, 100, Tutto]"
               data-show-footer="false"
               data-side-pagination="server"
               data-url="/inventario/table/getData"
               data-response-handler="responseHandler">
        </table>
</div>


        <div id="qrcode" style="display: none;"></div>

        <!-- Upload picture -->
        <div id="uploadPictureModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Carica Foto</h4>
                    </div>
                    <div class="modal-body">
                        <!-- Upload form. Note enctype attribute! -->
                        <form action="{% url "inventario.views.uploadPicture" %}" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <p>{{ picform.non_field_errors }}</p>
                            <p>{{ picform.picture.label_tag }} {{ picform.picture.help_text }}</p>
                            <p>
                                {{ picform.picture.errors }}
                                <span class="btn btn-primary btn-file">
                                    Scegli un Immagine... {{ picform.picture }}
                                </span>
                                {{ picform.id_bene }}
                            </p>
                            <button type="submit" class="btn btn-default">Invia</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- Upload picture -->

        <!-- Advanced Search -->
        <div id="advancedSearchModal" class="modal modal-wide fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Ricerca Avanzata</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <form id="advancedSearchForm" name="advancedSearchForm" action="{% url "inventario.views.advancedSearch" %}" method="post">
                                {% csrf_token %}
                                <p>{{ asform.non_field_errors }}</p>

                                <!-- ID -->
                                <p>{{ asform.min_id_bene.errors }}</p>
                                <p>{{ asform.max_id_bene.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_id_bene.label_tag }} {{ asform.min_id_bene.help_text }}{% render_field asform.min_id_bene class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_id_bene.label_tag }} {{ asform.max_id_bene.help_text }}{% render_field asform.max_id_bene class+="form-control" %}</div></p></div>
                                <!-- codice inventario -->
                                <div class="col-xs-12" style="margin-top:20px;padding-left:2.5%;padding-right:2.5%"><p>{{ asform.codice_inventario.label_tag }} {{ asform.codice_inventario.help_text }}{{ asform.codice_inventario.errors }}</p>
                                <div class="col-xs-12" style="padding-left:1%;padding-right:1%">
                                <ul class="list-group row">
                                {% for c in asform.codice_inventario %}
                                <li class="list-group-item col-xs-3" title="{{lista_codici | get_item:c.choice_label}}">{{ c }}</li>
                                {% endfor %}
                                </ul></div></div>
                                <!-- numero inventario -->
                                <p>{{ asform.min_pg_bene.errors }}</p>
                                <p>{{ asform.max_pg_bene.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_pg_bene.label_tag }} {{ asform.min_pg_bene.help_text }}{% render_field asform.min_pg_bene class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_pg_bene.label_tag }} {{ asform.max_pg_bene.help_text }}{% render_field asform.max_pg_bene class+="form-control" %}</div></p></div>
                                <!-- descrizione bene -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ds_bene.errors }}</p>
                                      <p>{{ asform.ds_bene.label_tag }} {{ asform.ds_bene.help_text }} {% render_field asform.ds_bene class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- data acquisto -->
                                <p>{{ asform.from_dt_acquisto.errors }}</p>
                                <p>{{ asform.to_dt_acquisto.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.from_dt_acquisto.label_tag }} {{ asform.from_dt_acquisto.help_text }}{% render_field asform.from_dt_acquisto class+="form-control datepicker" %}</div><div class="col-xs-6">
                                {{ asform.to_dt_acquisto.label_tag }} {{ asform.to_dt_acquisto.help_text }}{% render_field asform.to_dt_acquisto class+="form-control datepicker" %}</div></p></div>
                                <!-- categorie inventariali -->
                                <div class="col-xs-12" style="margin-top:20px;padding-left:2.5%;padding-right:2.5%"><p>{{ asform.categorie_inventariali.label_tag }} {{ asform.categorie_inventariali.help_text }}{{ asform.categorie_inventariali.errors }}</p>
                                <div class="col-xs-12" style="padding-left:1%;padding-right:1%">
                                <ul class="list-group row">
                                {% for c in asform.categorie_inventariali %}
                                <li class="list-group-item col-xs-4">{{ c }}</li>
                                {% endfor %}
                                </ul></div></div>
                                <!-- ubicazione -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ubicazione.errors }}</p>
                                      <p>{{ asform.ubicazione.label_tag }} {{ asform.ubicazione.help_text }} {% render_field asform.ubicazione class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- ubicazione precisa -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ubicazione_precisa.errors }}</p>
                                      <p>{{ asform.ubicazione_precisa.label_tag }} {{ asform.ubicazione_precisa.help_text }} {% render_field asform.ubicazione_precisa class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- data inizio ammortamento -->
                                <p>{{ asform.from_dt_ini_ammortamento.errors }}</p>
                                <p>{{ asform.to_dt_ini_ammortamento.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.from_dt_ini_ammortamento.label_tag }} {{ asform.from_dt_ini_ammortamento.help_text }}{% render_field asform.from_dt_ini_ammortamento class+="form-control datepicker" %}</div><div class="col-xs-6">
                                {{ asform.to_dt_ini_ammortamento.label_tag }} {{ asform.to_dt_ini_ammortamento.help_text }}{% render_field asform.to_dt_ini_ammortamento class+="form-control datepicker" %}</div></p></div>
                                <!-- Valore convenzionale -->
                                <p>{{ asform.min_valore_convenzionale.errors }}</p>
                                <p>{{ asform.max_valore_convenzionale.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_valore_convenzionale.label_tag }} {{ asform.min_valore_convenzionale.help_text }}{% render_field asform.min_valore_convenzionale class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_valore_convenzionale.label_tag }} {{ asform.max_valore_convenzionale.help_text }}{% render_field asform.max_valore_convenzionale class+="form-control" %}</div></p></div>
                                <!-- tipo documento -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.nome_tipo_dg.errors }}</p>
                                      <p>{{ asform.nome_tipo_dg.label_tag }} {{ asform.nome_tipo_dg.help_text }} {% render_field asform.nome_tipo_dg class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- numero documento -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.num_doc_rif.errors }}</p>
                                      <p>{{ asform.num_doc_rif.label_tag }} {{ asform.num_doc_rif.help_text }} {% render_field asform.num_doc_rif class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- numero registrazione -->
                                <p>{{ asform.min_num_registrazione.errors }}</p>
                                <p>{{ asform.max_num_registrazione.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_num_registrazione.label_tag }} {{ asform.min_num_registrazione.help_text }}{% render_field asform.min_num_registrazione class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_num_registrazione.label_tag }} {{ asform.max_num_registrazione.help_text }}{% render_field asform.max_num_registrazione class+="form-control" %}</div></p></div>
                                <!-- fornitore -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.denominazione.errors }}</p>
                                      <p>{{ asform.denominazione.label_tag }} {{ asform.denominazione.help_text }} {% render_field asform.denominazione class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- anno registrazione -->
                                <p>{{ asform.dt_registrazione_dg.errors }}</p>
                                <p>{{ asform.dt_registrazione_dg.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.dt_registrazione_dg.label_tag }} {{ asform.dt_registrazione_dg.help_text }}{% render_field asform.dt_registrazione_dg class+="form-control" %}</div></p></div>
                                <!-- nome -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.nome.errors }}</p>
                                      <p>{{ asform.nome.label_tag }} {{ asform.nome.help_text }} {% render_field asform.nome class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- cognome -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.cognome.errors }}</p>
                                      <p>{{ asform.cognome.label_tag }} {{ asform.cognome.help_text }} {% render_field asform.cognome class+="form-control" %}</p>
                                  </p>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary"  onClick="advancedSearch()">Cerca</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- Advanced Search -->

    </div>
    <!-- /#container -->
</div>
<!-- /#wrapper -->
{% endblock %}



{% block scripts %}
<script type="text/javascript">
    var AccurateLocationsList = [];     // the list with the parsed JSON needed by the editable plugin
    var AccurateLocationsArray = [];    // the array containing key-value elements to display when the row is expanded

    // the function parse the JSON data in the above 2 formats
    getAccurateLocationList(AccurateLocationsList, AccurateLocationsArray);  

    var $table = $('#table'),
            selections = [];

    function initTable() {

        $table.bootstrapTable({
            height: getHeight(),
            columns: [
                [
                    {
                        field: 'state',
                        checkbox: true,
                        align: 'center',
                        valign: 'middle'
                    },
                {
                        field: 'operate',
                        title: 'Azioni',
                        class: 'actions',
                        align: 'center',
                        events: operateEvents,
                        formatter: operateFormatter
                    }, 
                {
                    field: 'id_bene',
                    title: 'ID',
                    class: 'id_bene',
                    formatter: 'showSingleItem',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'cd_invent',
                    title: 'Codice Inventario',
                    class: 'cd_invent',
                    formatter: 'cdinventFormatter',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'pg_bene',
                    title: 'Numero Inventario',
                    formatter: 'numeroInventarioFormatter',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'ds_bene',
                    title: 'Descrizione Bene',
                    class: 'ds_bene',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'cd_categ_gruppo',
                    title: 'Categoria',
                    class: 'cd_categ_gruppo',
                    formatter: 'categoriaFormatter',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'dt_registrazione_buono',
                    title: 'Data Acquisto',
                    class: 'dt_registrazione_buono',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'ds_spazio',
                    title: 'Edificio',
                    class: 'ds_spazio',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'ubicazione_precisa',
                    title: 'Locale',
                    class: 'ubicazione_precisa',
                    editable: {
                        type: 'select',
                        inputclass: 'accurate-location-select',
                        source: AccurateLocationsList,
                        title: 'Nuovo Locale',
                        validate: function (value) {
                            value = $.trim(value);
                            if (!value) return 'This field is required';
                        },
                        url: '/inventario/table/editable/editAccurateLocation',
                        params: { csrfmiddlewaretoken:'{{csrf_token}}'},
                    },
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'dt_ini_ammortamento',
                    title: 'Data Inizio Ammortamento',
                    class: 'dt_ini_ammortamento',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'valore_convenzionale',
                    title: 'Valore Convenzionale',
                    class: 'valore_convenzionale',
                    sortable: true,
                    align: 'center'
                },{
                    field: 'nome_tipo_dg',
                    title: 'Tipo Documento',
                    class: 'nome_tipo_dg',
                    sortable: true,
                    align: 'center'
                },{
                    field: 'num_doc_rif',
                    title: 'Numero Documento',
                    class: 'num_doc_rif',
                    sortable: true,
                    align: 'center'
                },{
                    field: 'num_registrazione',
                    title: 'Numero Registrazione',
                    class: 'num_registrazione',
                    sortable: true,
                    align: 'center'
                },{
                    field: 'dt_registrazione_dg',
                    title: 'Anno Registrazione',
                    class: 'dt_registrazione_dg',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'denominazione',
                    title: 'Fornitore',
                    class: 'denominazione',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'possessore',
                    title: 'Possessore',
                    class: 'possessore',
                    formatter: 'possessoreFormatter',
                    sortable: true,
                    align: 'center'
                }

                // ,{
                //     field: 'nome',
                //     title: 'Nome',
                //     class: 'nome',
                //     sortable: true,
                //     align: 'center',
                //     formatter: possNameFormatter
                // },{
                //     field: 'cognome',
                //     title: 'Cognome',
                //     class: 'cognome',
                //     sortable: true,
                //     align: 'center',
                //     formatter: possSurnameFormatter
                // },
                ]
            ]
        });

        // sometimes footer render error.
        setTimeout(function () {
            $table.bootstrapTable('resetView');
        }, 200);

        // handler check, unckeck
        $table.on('check.bs.table uncheck.bs.table ' +
                'check-all.bs.table uncheck-all.bs.table', function () {

            // save your data, here just save the current page
            selections = getIdSelections();
            // push or splice the selections if you want to save all data selections
        });
        $table.on('all.bs.table', function (e, name, args) {
            console.log(name, args);
        });

        // resize handler
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        });
    }

    // which rows are selected
    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id_bene
        });
    }

    // put the data in the table
    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id_bene, selections) !== -1;
        });
        return res;
    }

    // handles the text formattation when the row is open
    function detailFormatter(index, row) {
        var html = [];
        $.each(row, function (key, value) {
            console.log(key.title);
            // if we're displaying the accurate location we must match the id with the actual text value
            if (key == 'accurate_location') 
            {
                if (value != "None")
                    html.push('<p><b>' + key + ':</b> ' + AccurateLocationsArray[value] + '</p>');
                else
                    html.push('<p><b>' + key + ':</b> Empty </p>');
            }
            // we need to show the render the immagine based on the filepath
            else if(key == 'immagine')
                if ( value != "")
                    html.push('<p><b>' + key + ':</b></p><p><img style="max-width:100px;max-height:100px" src="/inventario/media/' + value + '"></p>');
                else
                    html.push('<p><b>' + key + ': </b><b class="text-left text-danger">Foto non disponibile</b></p>');
            else if (key == 'nome' || key == 'cognome'){
              html.push('<p><b>' + key + ':</b> ' + possessoreFormatter(value, row, index) + '</p>');
            }
            // we hide the state 
            else if (key == 'state'){}
            else
                html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }


    function operateFormatter(value, row, index) {
        return [
            '<a class="Picture" href="javascript:void(0)" title="Carica una foto">',
            '<i class="glyphicon glyphicon-picture"></i>',
            '</a>  ',

            '<a class="QRcode" href="javascript:void(0)" title="Stampa il QRcode di questo bene">',
            '<i class="glyphicon glyphicon-qrcode"></i>',
            '</a>'
        ].join('');
    }

    window.operateEvents = {
        'click .Picture': function (e, value, row, index) {
            $('#id_id_bene').val(row.id_bene);
            $('#uploadPictureModal').modal();
        },
        'click .QRcode': function (e, value, row, index) {
            // alert('You click like action, row: ' + JSON.stringify(row));
            // makeQR(row.id);
            printSingleQrCode(row.id_bene)
            // alert("makeQR " + row.id);
        }
    };

    function getHeight() {
        return $(window).height() - $('#navbar1').outerHeight(true);
    }

    function showSingleItem(value, row) {
        return "<a href='/inventario/show/" + row.id_bene + "'>" + value + "</a>";
    }

    function numeroInventarioFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        return row.pg_bene + "-" + row.pg_bene_sub;
    }

    function categoriaFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        return row.cd_categ_gruppo + " - " + row.ds_categ_gruppo;
    }

    function cdinventFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        return row.cd_invent + " - " + row.ds_invent;
    }

    function possessoreFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        if (row.nome == "" && row.cognome == "")
          return "Vuoto";
        else
          return row.nome + " " + row.cognome;
    }

    $(function () {
        var scripts = [
                    location.search.substring(1) || 
                    "{% static 'js/bootstrap/bootstrap-table/bootstrap-table.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/editable/bootstrap-table-editable.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/editable/bootstrap-editable.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/export/bootstrap-table-export.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/export/tableExport.js' %}"

                ],
                eachSeries = function (arr, iterator, callback) {
                    callback = callback || function () {
                            };
                    if (!arr.length) {
                        return callback();
                    }
                    var completed = 0;
                    var iterate = function () {
                        iterator(arr[completed], function (err) {
                            if (err) {
                                callback(err);
                                callback = function () {
                                };
                            }
                            else {
                                completed += 1;
                                if (completed >= arr.length) {
                                    callback(null);
                                }
                                else {
                                    iterate();
                                }
                            }
                        });
                    };
                    iterate();
                };

        eachSeries(scripts, getScript, initTable);
    });

    function getScript(url, callback) {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = url;

        var done = false;
        // Attach handlers for all browsers
        script.onload = script.onreadystatechange = function () {
            if (!done && (!this.readyState ||
                    this.readyState == 'loaded' || this.readyState == 'complete')) {
                done = true;
                if (callback)
                    callback();

                // Handle memory leak in IE
                script.onload = script.onreadystatechange = null;
            }
        };

        head.appendChild(script);

        // We handle everything using the script element injection
        return undefined;
    }

    function getAccurateLocationList (ALL, ALA) {
        url = '/inventario/table/editable/getAccurateLocationList';
        items = [];
        $.ajax({ 
            type: 'GET', 
            url: url, 
            dataType: 'json',
            success: function (data) { 
                $.each(data, function(index, element) {
                        // alert("id= " + element.value + " value= " + element.text);
                        item = { value: element.value, text: element.text };
                        ALL.push(item);
                        ALA[element.value] = element.text;
                });
            }
        });
    }


    // mostra/nasconde l'input per aggiungere una nuova posizione
    function showNewAccLocationDiv () {
        if ($("#newAccLocationDiv").is(":visible")==false) $("#newAccLocationDiv").show();
        else $("#newAccLocationDiv").hide();
    }

    // chiamata ajax per salvare la nuova posizione nel DB ricarica la pagina al success per aggiornare la lista delle posizioni
    function addLocation () {
        // alert($("#newAccLocationText").val());
        nuovaUbicazione = $("#newAccLocationText").val();
        $.ajax({
            type: "POST",
            url: '/inventario/table/editable/addAccurateLocation',
            data: ({ nuovaUbicazione : nuovaUbicazione, csrfmiddlewaretoken:'{{csrf_token}}' }),
            success: function(result) {
                // alert('Nuova posizione aggiunta');
                location.reload();
                // $('#table').bootstrapTable('refresh');
            },
            error: function() {
                alert('Error occured');
            }
        });
    }

</script>

<!-- scripts to manage QrCodes -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/QrCodeScripts.js'%}"></script>
<!-- script to manage the quick search -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/QuickSearch.js'%}"></script>
<!-- script to manage the advanced search -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/AdvancedSearch.js'%}"></script>
<!-- script to manage the table export -->

<script type="text/javascript">
$( document ).ready(function() {
    $( "#inventarioLocaleLink" ).addClass( "active" );
});
</script>
{% endblock %}
