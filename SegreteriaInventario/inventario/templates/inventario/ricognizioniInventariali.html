{% extends "base.html" %}
{% load staticfiles %}
{% load widget_tweaks %}
{% load i18n %}

{% block stylesheets %}

<link href="{% static 'css/bootstrap/bootstrap-table/extensions/editable/bootstrap-editable.css'%}" rel="stylesheet">
<link href="{% static 'css/bootstrap/simple-sidebar/simple-sidebar.css'%}" rel="stylesheet">
<link href="{% static 'inventario/css/showLocalDBTableColumns.css'%}" rel="stylesheet">
{% endblock %}



{% block javascripts %}

<script type="text/javascript" src="{% static 'js/jquery.qrcode-0.12.0.min.js' %}"></script>
<!-- <script type="text/javascript" src="{% static 'js/bootstrap/bootstrap-table/extensions/export/bootstrap-table-export.js' %}"></script>
<script type="text/javascript" src="{% static 'js/bootstrap/bootstrap-table/extensions/export/tableExport.js' %}"></script> -->
{% endblock %}


{% block toggle_sidebar %}

<li id="showRapidSearch"><a href="#" ><b>Ricerca Rapida</b></a></li>
{% if user.is_authenticated %}
<li><a><b> Benvenuto {% if user.first_name and user.last_name %} {{ user.first_name}} {{ user.last_name }} {% else %} {{user.username}} {% endif %}</b></a></li>
{% endif %}

{% endblock %}


{% block body %}
<div id="wrapper" class="toggled">

    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <li class="sidebar-brand">
                <a id="hideRapidSearch" href="#">
                    Ricerca rapida
                </a>
            </li>
            <!--  Ubicazioni  -->
              <li>
                  <a href="#" id="btn-1" data-toggle="collapse" data-target="#submenu1" aria-expanded="false">Ubicazioni</a>
                  <ul class="nav collapse" id="submenu1" role="menu" aria-labelledby="btn-1">
                  {% for l in locations %}
                      <li ><a style="line-height:10px" href="#" title="{{l}}" onClick="ricognizioneInventarialeLocationSearch('{{l}}')">{{l}}</a></li>
                  {%endfor%}
                  </ul>    
              </li>
            <!--  Ubicazioni Precise  -->
            <li>
                <a href="#" id="btn-2" data-toggle="collapse" data-target="#submenu2" aria-expanded="false">Ubicazioni Precise</a>
                <ul class="nav collapse" id="submenu2" role="menu" aria-labelledby="btn-2">
                {% for al in accurateLocations %}
                    <li ><a style="line-height:10px" href="#" title="{{al}}" onClick="ricognizioneInventarialeAccurateLocationSearch('{{al}}')">{{al}}</a></li>
                {%endfor%}
                </ul>    
            </li>
        </ul>
    </div>
    <!-- /#sidebar-wrapper -->
    
    <div class="container col-xs-12" style="height:100%">

        <div id="toolbar">
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="$('#createRicInvModal').modal();"
                      title="Inserisci una nuova ricognizione inventariale"
                      >
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="showNewAccLocationDiv()"
                      title="Nuova posizione"
                      >
                <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>
              </button>
            </div>
            <div id="newAccLocationDiv" class="btn-group" role="group" style="display:none">
                <div class="btn-group" role="group">
                    <input type="text" class="form-control" id="newAccLocationText" placeholder="Nuova posizione...">
                </div>
                <div class="btn-group" role="group">
                  <button type="button"
                          class="btn btn-default"
                          onClick="addLocation()"
                          >
                    <!-- <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> -->
                  <b>ok</b>
                  </button>
                </div>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="$('#advancedSearchModal').modal();"
                      title="Ricerca Avanzata"
                      >
                <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
              </button>
            </div>
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-default"
                      onClick="ricognizioneInventarialeClearFilters();"
                      title="Rimuovi i filtri"
                      >
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
              </button>
            </div>
        </div>

        <div class="table-responsive">
                <table id="table"
                       data-toolbar="#toolbar"
                       data-search="true"
                       data-show-refresh="false"
                       data-show-toggle="false"
                       data-show-columns="true"
                       data-show-export="true"
                       data-detail-view="true"
                       data-detail-formatter="detailFormatter"
                       data-minimum-count-columns="2"
                       data-show-pagination-switch="false"
                       data-pagination="true"
                       data-id-field="id"
                       data-page-size="25"  
                       data-page-list="[1, 10, 25, 50, 100, ALL]"
                       data-show-footer="false"
                       data-side-pagination="server"
                       data-url="/inventario/table/getRicognizioniData"
                       data-response-handler="responseHandler">
                </table>
        </div>
        
        <!-- Create RecInv -->
        <div id="createRicInvModal" class="modal fade" role="dialog">
                        {% include "inventario/RicognizioneInventariale/create.html" %}
        </div>
        <!-- Edit RecInv -->
        <div id="editRicInvModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Modifica Ricognizione Inventariale</h4>
                    </div>
                    <div class="modal-body">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Search -->
        <div id="advancedSearchModal" class="modal modal-wide fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Ricerca Avanzata</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <form name="advancedRicognizioneInventarialeSearchForm" action="{% url "inventario.views.advancedRicognizioneInventarialeSearch" %}" method="post">
                                {% csrf_token %}
                                <p>{{ asform.non_field_errors }}</p>

                                <!-- ID -->
                                <p>{{ asform.min_id.errors }}</p>
                                <p>{{ asform.max_id.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_id.label_tag }} {{ asform.min_id.help_text }}{% render_field asform.min_id class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_id.label_tag }} {{ asform.max_id.help_text }}{% render_field asform.max_id class+="form-control" %}</div></p></div>
                                <!-- codice inventario -->
                                <div class="col-xs-12" style="margin-top:20px;padding-left:2.5%;padding-right:2.5%"><p>{{ asform.codice_inventario.label_tag }} {{ asform.codice_inventario.help_text }}{{ asform.codice_inventario.errors }}</p>
                                <div class="col-xs-12" style="padding-left:1%;padding-right:1%">
                                <ul class="list-group row">
                                {% for c in asform.codice_inventario %}
                                <li class="list-group-item col-xs-3">{{ c }}</li>
                                {% endfor %}
                                </ul></div></div>
                                <!-- numero inventario -->
                                <p>{{ asform.min_pg_bene.errors }}</p>
                                <p>{{ asform.max_pg_bene.errors }}</p>
                                <div class="col-xs-12"><p><div class="col-xs-6">{{ asform.min_pg_bene.label_tag }} {{ asform.min_pg_bene.help_text }}{% render_field asform.min_pg_bene class+="form-control" %}</div><div class="col-xs-6">
                                {{ asform.max_pg_bene.label_tag }} {{ asform.max_pg_bene.help_text }}{% render_field asform.max_pg_bene class+="form-control" %}</div></p></div>
                                <!-- descrizione bene -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ds_bene.errors }}</p>
                                      <p>{{ asform.ds_bene.label_tag }} {{ asform.ds_bene.help_text }} {% render_field asform.ds_bene class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- ubicazione -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ubicazione.errors }}</p>
                                      <p>{{ asform.ubicazione.label_tag }} {{ asform.ubicazione.help_text }} {% render_field asform.ubicazione class+="form-control" %}</p>
                                  </p>
                                </div>
                                <!-- ubicazione precisa -->
                                <div class="col-xs-12" style="padding-left:2.5%;padding-right:2.5%;">
                                  <p>
                                      <p>{{ asform.ubicazione_precisa.errors }}</p>
                                      <p>{{ asform.ubicazione_precisa.label_tag }} {{ asform.ubicazione_precisa.help_text }} {% render_field asform.ubicazione_precisa class+="form-control" %}</p>
                                  </p>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onClick="advancedSearchRicInv()">Cerca</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- Advanced Search -->

    </div>
    <!-- /#container -->
</div>
<!-- /#wrapper -->
{% endblock %}



{% block scripts %}
<script type="text/javascript">
    var AccurateLocationsList = [];     // the list with the parsed JSON needed by the editable plugin
    var AccurateLocationsArray = [];    // the array containing key-value elements to display when the row is expanded

    // the function parse the JSON data in the above 2 formats
    getAccurateLocationList(AccurateLocationsList, AccurateLocationsArray);  

    var $table = $('#table'),
            selections = [];

    function initTable() {

        $table.bootstrapTable({
            height: getHeight(),
            columns: [
                [
                //    {
                //        field: 'state',
                //        checkbox: true,
                //        align: 'center',
                //        valign: 'middle'
                //    },
                {
                        field: 'operate',
                        title: 'azioni',
                        class: 'actions',
                        align: 'center',
                        events: operateEvents,
                        formatter: operateFormatter
                    }, 
                {
                    field: 'cd_invent',
                    title: 'codice inventario',
                    class: 'cd_invent',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'pg_bene',
                    title: 'numero inventario',
                    formatter: 'numeroInventarioFormatter',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'ds_bene',
                    title: 'descrizione bene',
                    class: 'ds_bene',
                    sortable: true,
                    align: 'center'
                }, 
                {
                    field: 'ds_spazio',
                    title: 'ubicazione',
                    class: 'ds_spazio',
                    sortable: true,
                    align: 'center'
                }, {
                    field: 'ubicazione_precisa',
                    title: 'Ubicazione precisa',
                    class: 'ubicazione_precisa',
                    editable: {
                        type: 'select',
                        inputclass: 'accurate-location-select',
                        source: AccurateLocationsList,
                        title: 'Posizione Precisa',
                        validate: function (value) {
                            value = $.trim(value);
                            if (!value) return 'This field is required';
                        },
                        url: '/inventario/table/editable/editAccurateLocation',
                        params: { csrfmiddlewaretoken:'{{csrf_token}}'},
                    },
                    sortable: true,
                    align: 'center'
                }, 
                ]
            ]
        });

        // sometimes footer render error.
        setTimeout(function () {
            $table.bootstrapTable('resetView');
        }, 200);

        // handler check, unckeck
        $table.on('check.bs.table uncheck.bs.table ' +
                'check-all.bs.table uncheck-all.bs.table', function () {

            // save your data, here just save the current page
            selections = getIdSelections();
            // push or splice the selections if you want to save all data selections
        });
        $table.on('all.bs.table', function (e, name, args) {
            console.log(name, args);
        });

        // resize handler
        $(window).resize(function () {
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        });
    }

    // which rows are selected
    function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
            return row.id
        });
    }

    // put the data in the table
    function responseHandler(res) {
        $.each(res.rows, function (i, row) {
            row.state = $.inArray(row.id, selections) !== -1;
        });
        return res;
    }

    // handles the text formattation when the row is open
    function detailFormatter(index, row) {
        var html = [];
        $.each(row, function (key, value) {
            // if we're displaying the accurate location we must match the id with the actual text value
            if (key == 'accurate_location') 
            {
                if (value != "None")
                    html.push('<p><b>' + key + ':</b> ' + AccurateLocationsArray[value] + '</p>');
                else
                    html.push('<p><b>' + key + ':</b> Empty </p>');
            }
            // we need to show the render the immagine based on the filepath
            else if(key == 'immagine')
                if ( value != "")
                    html.push('<p><b>' + key + ':</b></p><p><img style="max-width:100px;max-height:100px" src="/inventario/media/' + value + '"></p>');
                else
                    html.push('<p><b>' + key + ': </b><b class="text-left text-danger">Foto non disponibile</b></p>');
            // we hide the state 
            else if (key == 'state'){}
            else
                html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }


    function operateFormatter(value, row, index) {
        return [
            '<a class="Modify" href="javascript:void(0)" title="Modifica">',
            '<i class="glyphicon glyphicon glyphicon-edit"></i>',
            '</a>  ',

            '<a class="Delete" href="javascript:void(0)" title="Cancella">',
            '<i class="glyphicon glyphicon glyphicon-trash"></i>',
            '</a>'
        ].join('');
    }

    window.operateEvents = {
        'click .Modify': function (e, value, row, index) {
            alert(row.id);
            //$('#id_id').val(row.id);
            //editRicinv(row);
            //$('#editRicInvModal').modal();
        },
        'click .Delete': function (e, value, row, index) {
        }
    };

    function editRicinv(id) {
        url = '/ricinv/edit/' + id;
        items = [];
        $.ajax({ 
            type: 'GET', 
            url: url, 
            dataType: 'html',
            success: function (data) { 
                $('#editRicInvModal').html(data);
            }
        });
    }

    function getHeight() {
        return $(window).height() - $('#navbar1').outerHeight(true);
    }

    function showSingleItem(value, row) {
        return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
    }

    function numeroInventarioFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        return row.pg_bene + "-" + row.pg_bene_sub;
    }

    function categoriaFormatter(value, row) {
        // return "<a href='/inventario/show/" + row.id + "'>" + value + "</a>";
        return row.cd_categ_gruppo + " - " + row.ds_categ_gruppo;
    }

    $(function () {
        var scripts = [
                    location.search.substring(1) || 
                    "{% static 'js/bootstrap/bootstrap-table/bootstrap-table.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/editable/bootstrap-table-editable.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/editable/bootstrap-editable.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/export/bootstrap-table-export.js' %}",
                    "{% static 'js/bootstrap/bootstrap-table/extensions/export/tableExport.js' %}"

                ],
                eachSeries = function (arr, iterator, callback) {
                    callback = callback || function () {
                            };
                    if (!arr.length) {
                        return callback();
                    }
                    var completed = 0;
                    var iterate = function () {
                        iterator(arr[completed], function (err) {
                            if (err) {
                                callback(err);
                                callback = function () {
                                };
                            }
                            else {
                                completed += 1;
                                if (completed >= arr.length) {
                                    callback(null);
                                }
                                else {
                                    iterate();
                                }
                            }
                        });
                    };
                    iterate();
                };

        eachSeries(scripts, getScript, initTable);
    });

    function getScript(url, callback) {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = url;

        var done = false;
        // Attach handlers for all browsers
        script.onload = script.onreadystatechange = function () {
            if (!done && (!this.readyState ||
                    this.readyState == 'loaded' || this.readyState == 'complete')) {
                done = true;
                if (callback)
                    callback();

                // Handle memory leak in IE
                script.onload = script.onreadystatechange = null;
            }
        };

        head.appendChild(script);

        // We handle everything using the script element injection
        return undefined;
    }

    function getAccurateLocationList (ALL, ALA) {
        url = '/inventario/table/editable/getAccurateLocationList';
        items = [];
        $.ajax({ 
            type: 'GET', 
            url: url, 
            dataType: 'json',
            success: function (data) { 
                $.each(data, function(index, element) {
                        // alert("id= " + element.value + " value= " + element.text);
                        item = { value: element.value, text: element.text };
                        ALL.push(item);
                        ALA[element.value] = element.text;
                });
            }
        });
    }


    // mostra/nasconde l'input per aggiungere una nuova posizione
    function showNewAccLocationDiv () {
        if ($("#newAccLocationDiv").is(":visible")==false) $("#newAccLocationDiv").show();
        else $("#newAccLocationDiv").hide();
    }

    // chiamata ajax per salvare la nuova posizione nel DB ricarica la pagina al success per aggiornare la lista delle posizioni
    function addLocation () {
        // alert($("#newAccLocationText").val());
        nuovaUbicazione = $("#newAccLocationText").val();
        $.ajax({
            type: "POST",
            url: '/inventario/table/editable/addAccurateLocation',
            data: ({ nuovaUbicazione : nuovaUbicazione, csrfmiddlewaretoken:'{{csrf_token}}' }),
            success: function(result) {
                // alert('Nuova posizione aggiunta');
                location.reload();
                // $('#table').bootstrapTable('refresh');
            },
            error: function() {
                alert('Error occured');
            }
        });
    }

</script>

<!-- scripts to manage QrCodes -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/QrCodeScripts.js'%}"></script>
<!-- script to manage the quick search -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/QuickSearch.js'%}"></script>
<!-- script to manage the advanced search -->
<script type="text/javascript" src="{% static 'inventario/js/inventarioLocale/AdvancedSearchRicInv.js'%}"></script>
<!-- script to manage the table export -->
<script>
    var $table = $('#table');
    $(function () {
        $('#toolbar').find('select').change(function () {
            $table.bootstrapTable('destroy').bootstrapTable({
                exportDataType: $(this).val()
            });
        });
    })
</script>

<script type="text/javascript">
window.addEventListener("DOMContentLoaded", function () {
  var form = document.getElementById("ricinv_form_id");

  document.getElementById("submit_btn_id").addEventListener("click", function () {
    form.submit();
  });
});
</script>

<script type="text/javascript">
$( document ).ready(function() {
    $( "#ricInvLink" ).addClass( "active" );
});
</script>
{% endblock %}
